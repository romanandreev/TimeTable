// Generated by CoffeeScript 1.4.0
(function() {

  window.getTimeTableJson = function() {
    var getAttr, getRowJson, getWeekday, wd, weekdays, _i, _len, _ref;
    getAttr = function(lesson, attr) {
      return $(lesson.cell).find(attr).text().trim();
    };
    getRowJson = function(top, bottom) {
      var all_lessons, btm_cells, getLessonJson, i, j, l, lesson, specs, top_cells, _i, _j, _k, _len, _ref, _results;
      top_cells = $(top).find('td');
      all_lessons = [];
      if (top_cells.length === 1) {
        all_lessons = [
          {
            cell: top_cells[0],
            spec: 'all'
          }
        ];
      } else {
        all_lessons = [
          {
            cell: top_cells[0],
            spec: 'sa'
          }, {
            cell: top_cells[1],
            spec: 'sm'
          }, {
            cell: top_cells[2],
            spec: 'mm'
          }
        ];
      }
      for (i = _i = 0, _ref = all_lessons.length; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
        lesson = all_lessons[i];
        if ($(top_cells[i]).attr('rowspan') !== '2') {
          lesson.fortnightly = 1;
          all_lessons[i] = lesson;
        }
      }
      btm_cells = $(bottom).find('td');
      if (btm_cells.length > 0) {
        if (btm_cells.length === 1 && $(btm_cells[0]).attr('colspan') === '3') {
          all_lessons.push({
            cell: btm_cells[0],
            spec: 'all',
            fortnightly: 2
          });
        } else {
          specs = ['sa', 'sm', 'mm'];
          j = 0;
          for (i = _j = 0; _j <= 2; i = ++_j) {
            if ($(top_cells[i]).attr('rowspan') !== '2') {
              all_lessons.push({
                cell: btm_cells[j],
                spec: specs[i],
                fortnightly: 2
              });
              j += 1;
            }
          }
        }
      }
      getLessonJson = function(lesson) {
        var cell, id, json, part, rowspan;
        json = {
          spec: lesson.spec,
          location: getAttr(lesson, '.loc'),
          course: {}
        };
        cell = $(lesson.cell);
        id = cell.find('.lessonid')[0];
        if (id != null) {
          json.course.id = $(id).attr('value');
        } else {
          json.course.name = getAttr(lesson, '.name');
          json.course.prof = getAttr(lesson, '.prof');
        }
        part = cell.find('.coursepart')[0];
        if (part != null) {
          json.course.part = $(part).attr('value');
        }
        rowspan = parseInt(cell.attr('rowspan'));
        if (lesson.fortnightly) {
          json.fortnightly = lesson.fortnightly;
        }
        return json;
      };
      _results = [];
      for (_k = 0, _len = all_lessons.length; _k < _len; _k++) {
        l = all_lessons[_k];
        if ($(l.cell).text().trim().length > 0) {
          _results.push(getLessonJson(l));
        }
      }
      return _results;
    };
    getWeekday = function(weekday) {
      var btm_rows, getLessons, i, rows, top_rows, _i, _results;
      rows = {};
      top_rows = $("." + weekday + ".top");
      btm_rows = $("." + weekday + ".btm");
      getLessons = function(index) {
        return getRowJson(top_rows[index], btm_rows[index]);
      };
      _results = [];
      for (i = _i = 0; _i <= 4; i = ++_i) {
        _results.push(getLessons(i));
      }
      return _results;
    };
    weekdays = {};
    _ref = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      wd = _ref[_i];
      weekdays[wd] = getWeekday(wd);
    }
    return {
      weekdays: weekdays,
      year: $("#year")[0].value,
      semester: $("#sem")[0].value
    };
  };

}).call(this);
